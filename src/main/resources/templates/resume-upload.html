<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      th:replace="~{layout :: layout(pageTitle='Upload Resume', activePage='upload', content=~{::content})}">
<body>
<div th:fragment="content">
    <div class="max-w-4xl mx-auto space-y-8">
        <!-- Header -->
        <div class="text-center">
            <h1 class="text-4xl font-bold text-gray-900 mb-4">Upload Your Resume</h1>
            <p class="text-lg text-gray-600">
                Upload your existing resume in PDF, DOCX, or TXT format and let our AI extract the information
            </p>
        </div>

        <!-- Upload Area -->
        <div class="bg-white rounded-lg shadow-md p-8">
            <div id="dropZone" 
                 class="border-2 border-dashed border-gray-300 rounded-lg p-12 text-center hover:border-indigo-500 transition-colors cursor-pointer"
                 ondrop="handleDrop(event)" 
                 ondragover="handleDragOver(event)"
                 onclick="document.getElementById('fileInput').click()">
                <i data-lucide="upload" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">
                    Drag and drop your resume here
                </h3>
                <p class="text-gray-500 mb-4">or click to browse</p>
                <p class="text-sm text-gray-400">Supports: PDF, DOCX, TXT (Max 10MB)</p>
                <input type="file" 
                       id="fileInput" 
                       accept=".pdf,.docx,.txt" 
                       onchange="handleFileChange(event)" 
                       class="hidden">
            </div>

            
            <!-- Selected File Display -->
            <div id="selectedFile" class="hidden mt-6 p-4 bg-gray-50 rounded-lg">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i data-lucide="file-text" class="w-8 h-8 text-indigo-600 mr-3"></i>
                        <div>
                            <p id="fileName" class="font-semibold text-gray-900"></p>
                            <p id="fileSize" class="text-sm text-gray-500"></p>
                        </div>
                    </div>
                    <button onclick="clearFile()" class="text-red-600 hover:text-red-800">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                <div class="flex items-center">
                    <i data-lucide="alert-circle" class="w-5 h-5 text-red-600 mr-2"></i>
                    <p id="errorText" class="text-red-600"></p>
                </div>
            </div>

            <!-- Success Message -->
            <div id="successMessage" class="hidden mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                <div class="flex items-center">
                    <i data-lucide="check-circle" class="w-5 h-5 text-green-600 mr-2"></i>
                    <p class="text-green-600">Resume uploaded successfully! Redirecting...</p>
                </div>
            </div>

            <!-- Upload Button -->
            <button id="uploadBtn" 
                    onclick="handleUpload()" 
                    disabled
                    class="w-full mt-6 px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
                <span id="uploadText">Upload Resume</span>
                <span id="uploadingText" class="hidden">Uploading...</span>
            </button>
        </div>

        <!-- Instructions -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
            <h3 class="font-semibold text-blue-900 mb-2 flex items-center">
                <i data-lucide="info" class="w-5 h-5 mr-2"></i>
                What happens after upload?
            </h3>
            <ul class="space-y-2 text-blue-800">
                <li class="flex items-start">
                    <span class="mr-2">•</span>
                    Our AI will automatically extract information from your resume
                </li>
                <li class="flex items-start">
                    <span class="mr-2">•</span>
                    You can review and edit the extracted information
                </li>
                <li class="flex items-start">
                    <span class="mr-2">•</span>
                    Match your resume with job descriptions to get compatibility scores
                </li>
                <li class="flex items-start">
                    <span class="mr-2">•</span>
                    Get AI-powered suggestions to improve your resume
                </li>
            </ul>
        </div>
    </div>

    <script>
        let selectedFile = null;

        function handleFileChange(event) {
            const file = event.target.files[0];
            if (file) {
                validateAndSetFile(file);
            }
        }

        function handleDrop(event) {
            event.preventDefault();
            const file = event.dataTransfer.files[0];
            if (file) {
                validateAndSetFile(file);
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
        }

        function validateAndSetFile(file) {
            hideMessages();
            
            const allowedTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/plain'];
            if (!allowedTypes.includes(file.type)) {
                showError('Please upload a PDF, DOCX, or TXT file');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                showError('File size should be less than 10MB');
                return;
            }

            selectedFile = file;
            displaySelectedFile(file);
        }

        function displaySelectedFile(file) {
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('selectedFile').classList.remove('hidden');
            document.getElementById('uploadBtn').disabled = false;
            lucide.createIcons();
        }

        function clearFile() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('selectedFile').classList.add('hidden');
            document.getElementById('uploadBtn').disabled = true;
            hideMessages();
        }

        async function handleUpload() {
            if (!selectedFile) {
                showError('Please select a file first');
                return;
            }

            const uploadBtn = document.getElementById('uploadBtn');
            const uploadText = document.getElementById('uploadText');
            const uploadingText = document.getElementById('uploadingText');
            
            uploadBtn.disabled = true;
            uploadText.classList.add('hidden');
            uploadingText.classList.remove('hidden');
            hideMessages();

            const formData = new FormData();
            formData.append('file', selectedFile);

            try {
                const response = await fetch('/api/resumes/upload', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    showSuccess();
                    setTimeout(() => {
                        window.location.href = `/resume/${data.id}`;
                    }, 1000);
                } else {
                    const error = await response.json();
                    showError(error.message || 'Failed to upload resume. Please try again.');
                    uploadBtn.disabled = false;
                    uploadText.classList.remove('hidden');
                    uploadingText.classList.add('hidden');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showError('Failed to upload resume. Please try again.');
                uploadBtn.disabled = false;
                uploadText.classList.remove('hidden');
                uploadingText.classList.add('hidden');
            }
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').classList.remove('hidden');
            lucide.createIcons();
        }

        function showSuccess() {
            document.getElementById('successMessage').classList.remove('hidden');
            lucide.createIcons();
        }

        function hideMessages() {
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('successMessage').classList.add('hidden');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
    </script>
</div>
</body>
</html>
